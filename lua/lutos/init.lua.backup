local M = {}

local state = require("lutos.state")
local config = require("lutos.config")

-- Available colors (similar to VSCode Peacock defaults)
local COLORS = {
  { name = "Angular Red", color = "#dd0531" },
  { name = "Azure Blue", color = "#007fff" },
  { name = "JavaScript Yellow", color = "#f9e64f" },
  { name = "Mandalorian Blue", color = "#1857a4" },
  { name = "Node Green", color = "#215732" },
  { name = "React Blue", color = "#61dafb" },
  { name = "Something Different", color = "#832561" },
  { name = "Svelte Orange", color = "#ff3d00" },
  { name = "Vue Green", color = "#42b883" },
  { name = "Red", color = "#ff5555" },
  { name = "Green", color = "#50fa7b" },
  { name = "Yellow", color = "#f1fa8c" },
  { name = "Blue", color = "#8be9fd" },
  { name = "Magenta", color = "#ff79c6" },
  { name = "Orange", color = "#ffb86c" },
  { name = "Purple", color = "#bd93f9" },
  { name = "Pink", color = "#ff92df" },
  { name = "None", color = nil }, -- Remove color
}

-- Get current workspace (directory)
local function get_workspace()
  return vim.fn.getcwd()
end

-- Set highlight color for the bar
local function set_bar_highlight(color)
  if color then
    vim.api.nvim_set_hl(0, "LutosBar", { bg = color })
  end
end

-- Build statuscolumn string with colored bar
local function build_statuscolumn(color, width)
  if not color then
    return nil -- No statuscolumn override
  end

  -- Create a bar of specified width with the highlight
  local bar = string.rep(" ", width)
  -- Statuscolumn format: colored bar + signs + line numbers
  return string.format("%%#LutosBar#%s%%*%%s%%l ", bar)
end

-- Apply statuscolumn to a window
local function apply_statuscolumn_to_window(winid)
  if not vim.api.nvim_win_is_valid(winid) then
    return
  end

  local bufnr = vim.api.nvim_win_get_buf(winid)

  -- Skip special buffers
  local buftype = vim.bo[bufnr].buftype
  if buftype ~= "" then
    return
  end

  local workspace = get_workspace()
  local color = state.get_color(workspace)
  local width = config.options.bar_width or 2

  if color then
    set_bar_highlight(color)
    local stc = build_statuscolumn(color, width)
    vim.wo[winid].statuscolumn = stc
  else
    -- Remove statuscolumn override
    vim.wo[winid].statuscolumn = ""
  end
end

-- Apply to all windows
local function apply_to_all_windows()
  for _, winid in ipairs(vim.api.nvim_list_wins()) do
    apply_statuscolumn_to_window(winid)
  end
end

-- Show color picker
local function pick_color()
  local workspace = get_workspace()
  local current_color = state.get_color(workspace)
  
  -- Build menu items
  local items = {}
  for _, c in ipairs(COLORS) do
    local prefix = (current_color == c.color) and "‚óè " or "  "
    table.insert(items, prefix .. c.name)
  end
  
  vim.ui.select(items, {
    prompt = "Pick color for workspace: " .. vim.fn.fnamemodify(workspace, ":~"),
  }, function(choice, idx)
    if not choice then
      return
    end
    
    local selected = COLORS[idx]
    
    if selected.color then
      print(string.format("Lutos: %s applied to workspace", selected.name))
      state.set_color(workspace, selected.color)
    else
      print("Lutos: Color removed from workspace")
      state.set_color(workspace, nil)
    end
    
    -- Apply to all windows
    apply_to_all_windows()
  end)
end

-- Setup autocmds
local function setup_autocmds()
  local group = vim.api.nvim_create_augroup("Lutos", { clear = true })
  
  -- Apply statuscolumn when window is entered or created
  vim.api.nvim_create_autocmd({ "WinEnter", "WinNew", "BufWinEnter" }, {
    group = group,
    callback = function()
      local winid = vim.api.nvim_get_current_win()
      vim.defer_fn(function()
        apply_statuscolumn_to_window(winid)
      end, 10)
    end,
  })
  
  -- Handle directory changes
  vim.api.nvim_create_autocmd("DirChanged", {
    group = group,
    callback = function()
      apply_to_all_windows()
    end,
  })
end

-- Setup function
function M.setup(opts)
  config.setup(opts or {})
  state.load()
  
  -- Apply current workspace color on startup
  vim.defer_fn(function()
    apply_to_all_windows()
  end, 100)
  
  -- Setup autocmds
  setup_autocmds()
  
  -- Setup keymaps
  local wk = require("which-key")
  wk.add({
    { "<leader>w", group = "workspace" },
    { "<leader>wp", pick_color, desc = "Paint workspace (lutos color picker)" },
  })
end

return M
